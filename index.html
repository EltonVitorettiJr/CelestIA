<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logotipo.png" type="image/png" />
  <title>CelestIA</title>
  <style>
    /* S√≥ um estilo r√°pido para os bot√µes ao lado da mensagem */
    .response-message {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #icone-audio-ia {
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topo">
      <img src="logotipo.png" alt="Ilustra√ß√£o de assistente virtual" class="imagem-destaque" />
    </div>

    <div class="box-questions">
      <div class="header">O que posso fazer por voc√™ hoje?</div>
      <p id="status"></p>

      <div id="history" class="chat-history"></div>

      <div class="footer">
        <input type="text" id="message-input" placeholder="Escreva aqui..." autocomplete="off" />
        <button class="btn-submit" id="btn-submit" onclick="sendMessage()">Enviar</button>
      </div>
      <div class="controles-audio">
        <div class="velocidade-container">
          <label>Velocidade: </label>
          <input type="range" min="0.5" max="1.5" step="0.1" value="0.9" id="velocidade-fala" onchange="velocidadeFala = parseFloat(this.value)">
        </div>
      
        <div class="volume-container">
          <label>Volume: </label>
          <input type="range" min="0" max="1" step="0.1" value="1" id="volume-fala" onchange="volumeFala = parseFloat(this.value)">
        </div>
      </div>
    </div>
  </div>

  <script>
    let utterance;
    let falando = false;
    let velocidadeFala = 0.9; // üîπ Adicione esta linha (vari√°vel de controle)
    let volumeFala = 1; // üîπ Adicione esta linha (volume padr√£o)

    // üîπ Fun√ß√£o auxiliar para carregar vozes
    function carregarVozes() {
      return new Promise((resolve) => {
        const vozesDisponiveis = speechSynthesis.getVoices();
        if (vozesDisponiveis.length > 0) {
          resolve(vozesDisponiveis);
        } else {
          speechSynthesis.onvoiceschanged = () => {
            resolve(speechSynthesis.getVoices());
          };
        }
      });
    }

    // üîπ Fun√ß√£o principal de fala (ATUALIZADA)
    async function toggleFala(texto, botao) {
      // Obter estado espec√≠fico deste bot√£o
      const estaFalando = botao.classList.contains('falando');
      
      if (estaFalando) {
          speechSynthesis.cancel();
          botao.classList.remove('falando');
          atualizarIcone(botao, false);
          return;
      }

      // Verifica se a API est√° dispon√≠vel
      if (!('speechSynthesis' in window)) {
        alert("Recurso de voz n√£o suportado neste navegador!");
        return;
      }

      try {
        const vozes = await carregarVozes();
        utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'pt-BR';
        
        // Configura√ß√µes melhoradas
        utterance.rate = velocidadeFala; // Usa a vari√°vel de controle
        utterance.pitch = 0.8; // Tom mais natural
        utterance.volume = volumeFala;

        // Sele√ß√£o de voz melhorada
        const vozPreferida = vozes.find(v => 
          v.name.includes("Google portugu√™s") || 
          v.name.includes("Luciana") || 
          v.lang === 'pt-BR'
        );
        
        utterance.voice = vozPreferida || null;

        // Eventos atualizados
        utterance.onstart = () => {
                botao.classList.add('falando');
                atualizarIcone(botao, true);
            };

            utterance.onend = utterance.onerror = () => {
                botao.classList.remove('falando');
                atualizarIcone(botao, false);
            };

            speechSynthesis.speak(utterance);
      } catch (error) {
          console.error("Erro na s√≠ntese de voz:", error);
          alert("Erro ao reproduzir √°udio");
      }
    }

    function atualizarIcone(botao, estaFalando) {
        if (estaFalando) {
            botao.textContent = 'üîà';  // √çcone falando
        } else {
            botao.textContent = 'üîá';  // √çcone mudo
        }
    }

    async function sendMessage() {
      const input = document.getElementById("message-input");
      const message = input.value.trim();
      if (!message) return;

      appendMessage("user", message);
      input.value = "";

      try {
        const response = await fetch("http://localhost:3000/proxy-chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userMessage: message }),
        });

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "Desculpe, n√£o consegui responder.";
        appendMessage("bot", reply);
      } catch (error) {
        console.error("Erro:", error);
        appendMessage("bot", "Ocorreu um erro ao se comunicar com o assistente.");
      }
    }

    function appendMessage(type, text) {
      const history = document.getElementById("history");

      const wrapper = document.createElement("div");
      wrapper.className = type === "user" ? "box-my-message" : "box-response-message";

      const bubble = document.createElement("div");
      bubble.className = type === "user" ? "my-message" : "response-message";

      if (type === "bot") {
        const textoSpan = document.createElement("span");
        textoSpan.id = "texto-ia";
        textoSpan.textContent = text;

        const botaoAudio = document.createElement("button");
        botaoAudio.classList.add('icone-audio'); // üîπ Use CLASSE em vez de ID
        botaoAudio.textContent = "üîá";
        // üîπ Passe o bot√£o como par√¢metro
        botaoAudio.onclick = () => toggleFala(textoSpan.textContent, botaoAudio);

        bubble.appendChild(textoSpan);
        bubble.appendChild(botaoAudio);
      } else {
        bubble.textContent = text;
      }

      wrapper.appendChild(bubble);
      history.appendChild(wrapper);
      history.scrollTop = history.scrollHeight;
    }

    // ESCUTA o Enter no input para enviar mensagem
    document.getElementById('message-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    });

    // Para garantir que as vozes estejam carregadas (bug do Chrome)
    window.speechSynthesis.onvoiceschanged = () => {
      console.log('Vozes carregadas', speechSynthesis.getVoices());
    };
  </script>
</body>
</html>
