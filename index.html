<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logotipo.png" type="image/png" />
  <title>CelestIA</title>
  <style>
    /* S√≥ um estilo r√°pido para os bot√µes ao lado da mensagem */
    .response-message {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #icone-audio-ia {
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topo">
      <img src="logotipo.png" alt="Ilustra√ß√£o de assistente virtual" class="imagem-destaque" />
    </div>

    <div class="box-questions">
      <div class="header">O que posso fazer por voc√™ hoje?</div>
      <p id="status"></p>

      <div id="history" class="chat-history"></div>

      <div class="footer">
        <input type="text" id="message-input" placeholder="Escreva aqui..." autocomplete="off" />
        <button class="btn-submit" id="btn-submit" onclick="sendMessage()">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    let utterance;
    let falando = false;

    function toggleFala(texto) {
      if (falando) {
        speechSynthesis.cancel();
        falando = false;
        atualizarIcone(false);
        return;
      }

      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }

      utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = 'pt-BR';
      utterance.rate = 1;
      utterance.pitch = 1;

      const vozes = speechSynthesis.getVoices();
      const aluciana = vozes.find(v => v.name.includes("Microsoft Aluciana"));
      if (aluciana) {
        utterance.voice = aluciana;
      }

      utterance.onstart = () => {
        falando = true;
        atualizarIcone(true);
      };

      utterance.onend = () => {
        falando = false;
        atualizarIcone(false);
      };

      speechSynthesis.speak(utterance);
    }

    function atualizarIcone(estaFalando) {
      const icone = document.getElementById('icone-audio-ia');
      if (!icone) return; // Se n√£o existir, evita erro

      if (estaFalando) {
        icone.textContent = 'üîà';  // √çcone falando
      } else {
        icone.textContent = 'üîá';  // √çcone mudo
      }
    }

    async function sendMessage() {
      const input = document.getElementById("message-input");
      const message = input.value.trim();
      if (!message) return;

      appendMessage("user", message);
      input.value = "";

      try {
        const response = await fetch("http://localhost:3000/proxy-chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userMessage: message }),
        });

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "Desculpe, n√£o consegui responder.";
        appendMessage("bot", reply);
      } catch (error) {
        console.error("Erro:", error);
        appendMessage("bot", "Ocorreu um erro ao se comunicar com o assistente.");
      }
    }

    function appendMessage(type, text) {
      const history = document.getElementById("history");

      const wrapper = document.createElement("div");
      wrapper.className = type === "user" ? "box-my-message" : "box-response-message";

      const bubble = document.createElement("div");
      bubble.className = type === "user" ? "my-message" : "response-message";

      if (type === "bot") {
        const textoSpan = document.createElement("span");
        textoSpan.id = "texto-ia";
        textoSpan.textContent = text;

        const botaoAudio = document.createElement("button");
        botaoAudio.id = "icone-audio-ia";
        botaoAudio.textContent = "üîá";
        botaoAudio.onclick = () => toggleFala(textoSpan.textContent);

        bubble.appendChild(textoSpan);
        bubble.appendChild(botaoAudio);
      } else {
        bubble.textContent = text;
      }

      wrapper.appendChild(bubble);
      history.appendChild(wrapper);
      history.scrollTop = history.scrollHeight;
    }

    // ESCUTA o Enter no input para enviar mensagem
    document.getElementById('message-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    });

    // Para garantir que as vozes estejam carregadas (bug do Chrome)
    window.speechSynthesis.onvoiceschanged = () => {
      console.log('Vozes carregadas', speechSynthesis.getVoices());
    };
  </script>
</body>
</html>
