<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logotipo.png" type="image/png" />
  <title>CelestIA</title>
  <style>
    .response-message {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #icone-audio-ia {
      cursor: pointer;
      font-size: 20px;
      background: none;
      border: none;
      outline: none;
    }

    .botoes-mensagem {
      position: absolute;
      right: 10px;
      bottom: 10px;
      display: flex;
      gap: 5px;
    }
    
    .botao-velocidade {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .botao-velocidade:hover {
      background: rgba(118, 169, 255, 0.3);
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topo">
      <img src="logotipo.png" alt="IlustraÃ§Ã£o de assistente virtual" class="imagem-destaque" />
    </div>

    <div class="box-questions">
      <div class="header">O que posso fazer por vocÃª hoje?</div>
      <p id="status"></p>

      <div id="history" class="chat-history"></div>

      <div class="footer">
        <input type="text" id="message-input" placeholder="Escreva aqui..." autocomplete="off" />
        <button class="btn-submit" id="btn-submit" onclick="sendMessage()">Enviar</button>
      </div>
        <!-- <div class="velocidade-container">
          <label>Velocidade: </label>
          <input type="range" min="0.5" max="1.5" step="0.1" value="1.3" id="velocidade-fala" onchange="velocidadeFala = parseFloat(this.value)">
        </div> -->
    </div>
  </div>

  <script>
    let utterance;
    let falando = false;
    let velocidadeFala = 1.2;
    const velocidades = [0.8, 1.2, 1.5];
    let indiceVelocidade = 0; // ComeÃ§a com 0.8x

    function carregarVozes() {
      return new Promise((resolve) => {
        const vozesDisponiveis = speechSynthesis.getVoices();
        if (vozesDisponiveis.length > 0) {
          resolve(vozesDisponiveis);
        } else {
          speechSynthesis.onvoiceschanged = () => {
            resolve(speechSynthesis.getVoices());
          };
        }
      });
    }

    async function toggleFala(texto, botao) {
      const estaFalando = botao.classList.contains('falando');
      
      if (estaFalando) {
        speechSynthesis.cancel();
        botao.classList.remove('falando');
        botao.textContent = "ðŸ”Š";
        return;
      }

      if (!('speechSynthesis' in window)) {
        alert("Recurso de voz nÃ£o suportado neste navegador!");
        return;
      }

      try {
        const vozes = await carregarVozes();
        utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'pt-BR';
        
        // Obter velocidade da mensagem especÃ­fica
        const mensagem = botao.closest('.box-response-message');
        const indiceVel = parseInt(mensagem.dataset.velocidadeIndex) || 0;
        utterance.rate = [0.8, 1.2, 1.5][indiceVel];
        
        utterance.pitch = 0.8;

        const vozPreferida = vozes.find(v => 
          v.name.includes("Google portuguÃªs") || 
          v.name.includes("Luciana") || 
          v.lang === 'pt-BR'
        );
        
        utterance.voice = vozPreferida || null;

        utterance.onstart = () => {
          botao.classList.add('falando');
          botao.textContent = 'ðŸ”ˆ';
        };

        utterance.onend = utterance.onerror = () => {
          botao.classList.remove('falando');
          botao.textContent = 'ðŸ”Š';
        };

        speechSynthesis.speak(utterance);
      } catch (error) {
        console.error("Erro na sÃ­ntese de voz:", error);
        alert("Erro ao reproduzir Ã¡udio");
      }
    }

    function proximaVelocidade(botao, mensagemId) {
      const velocidades = [0.8, 1.2, 1.5];
      const mensagem = document.getElementById(mensagemId);
      
      let indice = parseInt(mensagem.dataset.velocidadeIndex) || 0;
      indice = (indice + 1) % velocidades.length;
      
      mensagem.dataset.velocidadeIndex = indice;
      botao.textContent = velocidades[indice] + 'x';
      
      // Atualizar velocidade se estiver falando
      const botaoAudio = mensagem.querySelector('.icone-audio');
      if (botaoAudio.classList.contains('falando')) {
        speechSynthesis.cancel();
        setTimeout(() => {
          toggleFala(mensagem.querySelector('.texto-mensagem').textContent, botaoAudio);
        }, 100);
      }
    }

    function atualizarIcone(botao, estaFalando) {
        if (estaFalando) {
            botao.textContent = 'ðŸ”ˆ';
        } else {
            botao.textContent = 'ðŸ”‡';
        }
    }

    async function sendMessage() {
      const input = document.getElementById("message-input");
      const message = input.value.trim();
      if (!message) return;

      appendMessage("user", message);
      input.value = "";

      try {
        const response = await fetch("http://localhost:3000/proxy-chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userMessage: message }),
        });

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "Desculpe, nÃ£o consegui responder.";
        appendMessage("bot", reply);
      } catch (error) {
        console.error("Erro:", error);
        appendMessage("bot", "Ocorreu um erro ao se comunicar com o assistente.");
      }
    }

    function appendMessage(type, text) {
      const history = document.getElementById("history");
      const messageId = 'msg-' + Date.now();

      const wrapper = document.createElement("div");
      wrapper.className = type === "user" ? "box-my-message" : "box-response-message";
      wrapper.id = messageId;
      wrapper.dataset.velocidadeIndex = "0"; // Inicia com 0.8x
      
      const bubble = document.createElement("div");
      bubble.className = type === "user" ? "my-message" : "response-message";
      bubble.classList.add("mensagem-container");

      const textoSpan = document.createElement("span");
      textoSpan.className = "texto-mensagem";
      textoSpan.textContent = text;
      bubble.appendChild(textoSpan);

      if (type === "bot") {
        // Container principal para a mensagem e botÃµes
        const contentContainer = document.createElement("div");
        contentContainer.className = "message-content-container";
        
        // BotÃ£o de Ã¡udio DENTRO do container da mensagem
        const botaoAudio = document.createElement("button");
        botaoAudio.className = "icone-audio";
        botaoAudio.textContent = "ðŸ”Š";
        botaoAudio.onclick = () => toggleFala(text, botaoAudio);
        
        // Adiciona o texto e o botÃ£o de Ã¡udio
        const textContainer = document.createElement("div");
        textContainer.className = "texto-container";
        textContainer.appendChild(textoSpan);
        textContainer.appendChild(botaoAudio);
        
        contentContainer.appendChild(textContainer);

        // BotÃ£o de velocidade FORA do container (serÃ¡ posicionado via CSS)
        const botaoVelocidade = document.createElement("button");
        botaoVelocidade.className = "botao-velocidade";
        botaoVelocidade.textContent = "0.8x";
        botaoVelocidade.onclick = (e) => {
          e.stopPropagation();
          proximaVelocidade(botaoVelocidade, messageId);
        };
        
        // Adiciona ambos ao bubble
        bubble.appendChild(contentContainer);
        bubble.appendChild(botaoVelocidade);
      }

      wrapper.appendChild(bubble);
      history.appendChild(wrapper);
      history.scrollTop = history.scrollHeight;
    }

    document.getElementById('message-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    });

    window.speechSynthesis.onvoiceschanged = () => {
      console.log('Vozes carregadas', speechSynthesis.getVoices());
    };
  </script>
</body>
</html>
